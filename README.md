# 功能特性

模仿重要私人文件的ftp软件，只能远程读取，不能上传

基本功能：注册、登录、获取文件

# 协议

包头只由一个字节组成，标志着报文类型：前三位指示操作类型，后五位指示具体操作或者状态

操作类型：连接、账户操作、文件传输

| 标志            | 类型     | 发送方        | 含义                  | 备注   |
| --------------- | -------- | ------------- | --------------------- | ------ |
| 00000000 - 0x00 | 连接     | server        | 连接已初始化          | 未使用 |
| 00000001 - 0x01 | 连接     | server        | 会话密钥发送          |        |
| 00000010 - 0x02 | 连接     | client        | 会话密钥确认          |        |
| 00011111 - 0x1f | 连接     | server/client | 关闭连接              |        |
| 00100000 - 0x20 | 账户操作 | server        | 操作成功              |        |
| 00111111 - 0x3f | 账户操作 | server        | 操作失败              | 未使用 |
| 00100001 - 0x21 | 账户操作 | client        | 注册                  |        |
| 00100010 - 0x22 | 账户操作 | server        | 用户名已存在          |        |
| 00100011 - 0x23 | 账户操作 | server        | 用户名/密码格式不合法 |        |
| 00100100 - 0x24 | 账户操作 | client        | 登录                  |        |
| 00100101 - 0x25 | 账户操作 | server        | 用户名/密码错误       |        |
| 01000000 - 0x40 | 文件获取 | server/client | 操作成功              | 未使用 |
| 01011111 - 0x5f | 文件获取 | server/client | 操作失败              | 未使用 |
| 01000001 - 0x41 | 文件获取 | client        | 获取文件列表          |        |
| 01000010 - 0x42 | 文件获取 | client        | 获取指定文件          |        |
| 01000011 - 0x43 | 文件获取 | server        | 发送数据长度          |        |
| 01000100 - 0x44 | 文件获取 | client        | 确认接收              |        |
| 01000101 - 0x45 | 文件获取 | client        | 拒绝接收              |        |
| 01000110 - 0x46 | 文件获取 | server        | 传输数据              |        |
| 01000111 - 0x47 | 文件获取 | server        | 文件不存在            |        |

# 用户数据表

> MariaDB [SETrans]> DESC user;
> +----------+--------------+------+-----+---------+----------------+
> | Field    | Type         | Null | Key | Default | Extra          |
> +----------+--------------+------+-----+---------+----------------+
> | id       | int(11)      | NO   | PRI | NULL    | auto_increment |
> | username | varchar(16)  | NO   | PRI | NULL    |                |
> | usertype | varchar(16)  | NO   |     | NULL    |                |
> | password | varchar(256) | NO   |     | NULL    |                |
> +----------+--------------+------+-----+---------+----------------+

# Security Point

1. 加密信道
   1. 每个client单独分配随机会话密钥
   2. 会话密钥使用client-公钥加密，保证会话密钥的机密性
   3. 对每个会话密钥计算SHA256，并用server-私钥进行签名，保证不可抵赖性和防止中间人攻击，同时保证会话密钥的完整性
2. 由于前端可以抓包修改传输数据，因此都在后端进行严格的输入校验
   1. 后端先要判断加密的数据长度，在判断解密后数据的长度
   1. 发生传输过程中的错误（被抓包修改），即刻断开连接
3. 数据传输一次一密
   1. 使用AES的EAX模式
   2. 使用nonce随机数，存在完整性校验
4. 账户安全
   1. 无论是用户名不存在/密码输入错误，都只显示“用户名或密码错误”
   2. 用户名仅能是长度为4到16的英文字母或数字组合
   3. 密码仅能是长度为8到16的英文字母、数字，且至少包含一个大写字母、一个小写字母以及一个数字
5. 账户数据库安全
   1. 用户输入的用户名/密码使用预编译执行SQL，彻底杜绝SQL注入问题
   2. 用户密码加盐存储到数据库中，盐值采用长度为64的随机十六进制字符串
6. 文件获取安全
   1. 后端形成filehub目录的文件列表（字符串l）
   2. 用户传入的目标文件名进行白名单判定，只有在上述文件列表中才能成功传输（解决路径遍历漏洞）
7. 日志安全
   1. 用户操作在后端形成日志
   2. 对用户错误的输入进行记录