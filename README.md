# 协议
包头只由一个字节组成，标志着报文类型：前三位指示操作类型，后五位指示具体操作or状态

操作类型：连接、会话密钥初始化、账户操作、文件传输

| 标志            | 类型     | 发送方        | 含义                  | 备注   |
| --------------- | -------- | ------------- | --------------------- | ------ |
| 00000000 - 0x00 | 连接     | server        | 连接已初始化          | 未使用 |
| 00000001 - 0x01 | 连接     | server        | 会话密钥发送          |        |
| 00000010 - 0x02 | 连接     | client        | 会话密钥确认          |        |
| 00011111 - 0x1f | 连接     | server/client | 关闭连接              |        |
| 00100000 - 0x20 | 账户操作 | server        | 操作成功              |        |
| 00111111 - 0x3f | 账户操作 | server        | 操作失败              | 未使用 |
| 00100001 - 0x21 | 账户操作 | client        | 注册                  |        |
| 00100010 - 0x22 | 账户操作 | server        | 用户名已存在          |        |
| 00100011 - 0x23 | 账户操作 | server        | 用户名/密码格式不合法 |        |
| 00100100 - 0x24 | 账户操作 | client        | 登录                  |        |
| 00100101 - 0x25 | 账户操作 | server        | 用户名/密码错误       |        |
|                 |          |               |                       |        |
|                 |          |               |                       |        |
|                 |          |               |                       |        |
|                 |          |               |                       |        |

客户端会发送的数据：

1. 注册+用户名/密码
   1. 接收判断是否成功/用户名已存在/输入格式不合法
2. 登录+用户名/密码
   1. 接收判断是否成功/用户名or密码错误
3. ls
   1. 服务端发送列表长度，客户端发送确认
4. get+文件路径
   1. 服务端发送文件大小，客户端发送确认

# 用户数据表

> MariaDB [SETrans]> DESC user;
> +----------+--------------+------+-----+---------+----------------+
> | Field    | Type         | Null | Key | Default | Extra          |
> +----------+--------------+------+-----+---------+----------------+
> | id       | int(11)      | NO   | PRI | NULL    | auto_increment |
> | username | varchar(16)  | NO   | PRI | NULL    |                |
> | usertype | varchar(16)  | NO   |     | NULL    |                |
> | password | varchar(256) | NO   |     | NULL    |                |
> +----------+--------------+------+-----+---------+----------------+

# Security Point

1. 加密信道
   1. 每个client单独分配随机会话密钥
   2. 会话密钥使用client-公钥加密，保证会话密钥的机密性
   3. 对每个会话密钥计算SHA256，并用server-私钥进行签名，保证不可抵赖性和防止中间人攻击，同时保证会话密钥的完整性
2. 由于前端可以抓包修改传输数据，因此都在后端进行严格的输入校验
   1. 后端先要判断加密的数据长度，在判断解密后数据的长度
3. 无论是用户名不存在/密码输入错误，都只显示“用户名或密码错误”
4. 数据传输一次一密
   1. 使用AES的EAX模式
   2. 使用nonce随机数，存在完整性校验